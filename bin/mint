#!/bin/bash

set -e

METAFILE="$2"
ACT="$1"

[ -z $RIDHOME ]       && { echo '$RIDHOME is unset'; exit 1; }
[ -z $RIDMETA ]       && { echo '$RIDMETA is unset'; exit 1; }
[ -z $RIDTMP ]        && { echo '$RIDTMP is unset'; exit 1; }
[ -z $RIDBUILDING ]   && { echo '$RIDBUILDING is unset'; exit 1; }
[ -z $RIDEXTRACTION ] && { echo '$RIDEXTRACTINO is unset'; exit 1; }

find_metafile() {
  local metafile="$1"
  local result
  result=$(find "$RIDMETA" -type f -name "$metafile" ! -name "README.md" ! -name "LICENSE" 2>/dev/null)
  
  if [ -z "$result" ]; then
    echo "Metafile '$metafile' not found in $RIDMETA"
    exit 1
  fi
  echo "$result"
}

pre() {
  bv=$(compgen -v)
  . "$RIDHOME/env" || { echo "Failed to source $RIDHOME/env"; exit 1; }

  METAFILE_PATH=$(find_metafile "$METAFILE")
  . "$METAFILE_PATH" || die "Failed to source $METAFILE_PATH"

  av=$(compgen -v)
  rm -f $RIDTMP/failed
}

cleanup() {
  while [ ${#DIRSTACK[@]} -gt 1 ]; do
    popd > /dev/null
  done

  for var in $av; do
    if ! echo "$bv" | grep -q "^$var$"; then
      unset "$var"
    fi
  done
  rm -rf "$RIDBUILDING/$NAME-$VERS"
}

ins() {
  pushd "$RIDBUILDING/$NAME-$VERS" > /dev/null || die "Failed to enter build directory"
  idir
}

rem() {
  rdir
}

upd() {
  pushd "$RIDBUILDING/$NAME-$VERS" > /dev/null || die "Failed to enter build directory"
  if ! declare -f udir > /dev/null; then
      echo "Using install instructions..."
      idir
  else
      echo "Using update instructions..."
      udir
  fi
}

pre
case "$ACT" in
  i)
    ins || die "Install failure"
    cleanup
    ;;
  r)
    rem || die "Removal failure"
    cleanup
    ;;
  u)
    upd || die "Update failure"
    cleanup
    ;;
  v)
    echo "NAME: $NAME"
    echo "VERS: $VERS"
    echo "LINK: $LINK"
    echo "DOWN: $DOWN"
    echo "DEPS: $DEPS"
    echo "UPST: $UPST"
    echo "SELE: $SELE"
    echo "NEWS: $NEWS"
    ;;
  *)
    echo "Invalid action: $ACT"
    echo "Valid actions:"
    echo "i - install"
    echo "r - remove"
    echo "u - update"
    echo "v - variables"
    exit 1
    ;;
esac
